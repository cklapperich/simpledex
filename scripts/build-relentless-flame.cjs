#!/usr/bin/env node
/**
 * Build the "Relentless Flame" theme deck (Team Up) in PTCGO format.
 *
 * Looks up each card in cards-western.json by name, set, and number
 * to find the correct ptcgoCode, then outputs the formatted decklist.
 *
 * Saves to: decklists/relentless-flame.txt
 */

const path = require('path');
const fs = require('fs');
const cards = require(path.join(__dirname, '..', 'dist', 'cards-western.json'));

// Helper: find a card by exact English name, set name, and card number
function findCard(name, setName, number) {
  const match = cards.find(c => {
    const cardName = c.names?.en || c.name || '';
    return cardName === name && c.set === setName && c.number === String(number);
  });
  if (!match) {
    console.error(`WARNING: Could not find card: ${name} | ${setName} | ${number}`);
    return null;
  }
  return match;
}

// Helper: format a PTCGO line
function ptcgoLine(qty, card) {
  const name = card.names?.en || card.name || '???';
  const code = card.ptcgoCode || card.set;
  const num = card.number;
  return `* ${qty} ${name} ${code} ${num}`;
}

// ── Deck Definition (Relentless Flame - Team Up) ────────────────────
// Pokemon section
const pokemon = [
  { qty: 1, name: 'Charizard',       set: 'Team Up',    num: '14'  },  // Rare Holo
  { qty: 1, name: 'Charizard',       set: 'Team Up',    num: '14'  },  // Rare (same card)
  { qty: 2, name: 'Charmeleon',      set: 'Team Up',    num: '13'  },
  { qty: 3, name: 'Charmander',      set: 'Team Up',    num: '12'  },
  { qty: 2, name: 'Rapidash',        set: 'Team Up',    num: '18'  },
  { qty: 3, name: 'Ponyta',          set: 'Team Up',    num: '17'  },
  { qty: 2, name: 'Nidoqueen',       set: 'Team Up',    num: '56'  },
  { qty: 2, name: 'Nidorina',        set: 'Team Up',    num: '55'  },
  { qty: 3, name: 'Nidoran\u2640',   set: 'Team Up',    num: '54'  },  // Nidoran♀
  { qty: 3, name: 'Farfetch\u2019d', set: 'Team Up',    num: '127' },
];

// Trainer section
const trainers = [
  { qty: 2, name: 'Brock\u2019s Grit',      set: 'Team Up',          num: '135' },
  { qty: 2, name: 'Copycat',                 set: 'Celestial Storm',  num: '127' },
  { qty: 2, name: 'Cynthia',                 set: 'Ultra Prism',      num: '119' },
  { qty: 2, name: 'Hau',                     set: 'Celestial Storm',  num: '132' },
  { qty: 2, name: 'Nest Ball',               set: 'Sun & Moon',       num: '123' },
  { qty: 2, name: 'Pok\u00e9mon Fan Club',   set: 'Ultra Prism',      num: '133' },
  { qty: 2, name: 'Professor Kukui',         set: 'Sun & Moon',       num: '128' },
  { qty: 2, name: 'Switch',                  set: 'Celestial Storm',  num: '147' },
  { qty: 2, name: 'Timer Ball',              set: 'Sun & Moon',       num: '134' },
];

// ── Build the decklist ─────────────────────────────────────────────

// First, deduplicate pokemon entries (combine the two Charizards)
const pokemonMerged = [];
for (const entry of pokemon) {
  const existing = pokemonMerged.find(
    e => e.name === entry.name && e.set === entry.set && e.num === entry.num
  );
  if (existing) {
    existing.qty += entry.qty;
  } else {
    pokemonMerged.push({ ...entry });
  }
}

const lines = [];
let totalCards = 0;

// Count Pokemon and Trainers
let pokemonCount = 0;
for (const entry of pokemonMerged) pokemonCount += entry.qty;
let trainerCount = 0;
for (const entry of trainers) trainerCount += entry.qty;

// Pokemon header
lines.push('****** Pok\u00e9mon Trading Card Game Deck List ******');
lines.push('');
lines.push(`##Pok\u00e9mon - ${pokemonCount}`);
lines.push('');

for (const entry of pokemonMerged) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) {
    lines.push(ptcgoLine(entry.qty, card));
    totalCards += entry.qty;
  }
}

// Trainers header
lines.push('');
lines.push(`##Trainer Cards - ${trainerCount}`);
lines.push('');

for (const entry of trainers) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) {
    lines.push(ptcgoLine(entry.qty, card));
    totalCards += entry.qty;
  }
}

// Energy
lines.push('');
lines.push('##Energy - 20');
lines.push('');
lines.push('* 20 Fire Energy SUM 165');
totalCards += 20;

lines.push('');
lines.push('Total Cards - ' + totalCards);
lines.push('');
lines.push('****** Deck List Generated by SimpleDex ******');
lines.push('');

const output = lines.join('\n');
console.log(output);

// Save to file
const outPath = path.join(__dirname, '..', 'decklists', 'relentless-flame.txt');
fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, output, 'utf8');
console.log(`\nSaved to: ${outPath}`);
