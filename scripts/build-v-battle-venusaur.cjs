#!/usr/bin/env node
const path = require("path");
const fs = require("fs");
const cards = require(path.join(__dirname, "..", "dist", "cards-western.json"));

function findCard(name, setName, number) {
  const match = cards.find(c => {
    const cardName = c.names?.en || c.name || "";
    return cardName === name && c.set === setName && c.number === String(number);
  });
  if (!match) {
    console.error("WARNING: Could not find card: " + name + " | " + setName + " | " + number);
    return null;
  }
  return match;
}

function ptcgoLine(qty, card) {
  const name = card.names?.en || card.name || "???";
  return "* " + qty + " " + name + " " + card.set + " " + card.number;
}

// V Battle Deck - Venusaur vs. Blastoise (Venusaur half)
// Source: Bulbapedia V_Battle_Deck Venusaur_vs._Blastoise_(TCG)
//
// Base 60-card deck (standalone Venusaur V Battle Deck)
// The vs. Blastoise bundle includes 8 additional bonus Trainer cards:
//   2x Boss Orders (Lysandre) SHF 58
//   2x Quick Ball SSH 179
//   2x Marnie SSH 169
//   2x Turbo Patch DAA 172

const pokemon = [
  { qty: 1, name: "Venusaur V",   set: "SWSH Black Star Promos", num: "SWSH100" },
  { qty: 2, name: "Yanmega",      set: "Shining Fates",          num: "2" },
  { qty: 3, name: "Yanma",        set: "Shining Fates",          num: "1" },
  { qty: 2, name: "Gogoat",       set: "Vivid Voltage",          num: "18" },
  { qty: 3, name: "Skiddo",       set: "Vivid Voltage",          num: "17" },
  { qty: 1, name: "Eldegoss",     set: "Shining Fates",          num: "15" },
  { qty: 2, name: "Gossifleur",   set: "Shining Fates",          num: "14" },
  { qty: 3, name: "Durant",       set: "Sword & Shield",         num: "8" },
  { qty: 2, name: "Heracross",    set: "Rebel Clash",            num: "6" },
  { qty: 2, name: "Indeedee",     set: "Shining Fates",          num: "56" },
];

const trainers = [
  { qty: 2, name: "Bede",              set: "Sword & Shield", num: "157" },
  { qty: 4, name: "Dan",               set: "Rebel Clash",    num: "158" },
  { qty: 1, name: "Evolution Incense", set: "Sword & Shield", num: "163" },
  { qty: 2, name: "Great Ball",        set: "Sword & Shield", num: "164" },
  { qty: 2, name: "Gym Trainer",       set: "Shining Fates",  num: "59" },
  { qty: 4, name: "Hop",               set: "Sword & Shield", num: "165" },
  { qty: 1, name: "Pokémon Catcher", set: "Sword & Shield", num: "175" },
  { qty: 2, name: "Potion",            set: "Sword & Shield", num: "177" },
  { qty: 1, name: "Sonia",             set: "Rebel Clash",    num: "167" },
  { qty: 2, name: "Switch",            set: "Sword & Shield", num: "183" },
];

const energy = [
  { qty: 18, name: "Grass Energy", set: "Sun & Moon", num: "164" },
];

const deckLines = [];
let totalCards = 0;
let pokemonCount = pokemon.reduce((s, e) => s + e.qty, 0);
let trainerCount = trainers.reduce((s, e) => s + e.qty, 0);
let energyCount = energy.reduce((s, e) => s + e.qty, 0);

deckLines.push("****** Pokémon Trading Card Game Deck List ******");
deckLines.push("");
deckLines.push("##Pokémon - " + pokemonCount);
deckLines.push("");

for (const entry of pokemon) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) { deckLines.push(ptcgoLine(entry.qty, card)); totalCards += entry.qty; }
}

deckLines.push("");
deckLines.push("##Trainer Cards - " + trainerCount);
deckLines.push("");

for (const entry of trainers) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) { deckLines.push(ptcgoLine(entry.qty, card)); totalCards += entry.qty; }
}

deckLines.push("");
deckLines.push("##Energy - " + energyCount);
deckLines.push("");

for (const entry of energy) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) { deckLines.push(ptcgoLine(entry.qty, card)); totalCards += entry.qty; }
}

deckLines.push("");
deckLines.push("Total Cards - " + totalCards);
deckLines.push("");
deckLines.push("****** Deck List Generated by SimpleDex ******");
deckLines.push("");

const output = deckLines.join("
");
console.log(output);

console.log("
--- VALIDATION ---");
console.log("Total cards: " + totalCards + (totalCards === 60 ? " (OK)" : " (ERROR: should be 60!)"));

const allEntries = [...pokemon, ...trainers];
for (const entry of allEntries) {
  if (entry.qty > 4) {
    console.log("WARNING: " + entry.name + " has " + entry.qty + " copies (exceeds 4-copy limit)");
  }
}

const outPath = path.join(__dirname, "..", "decklists", "gen9-10-V-Battle-Venusaur.txt");
fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, output, "utf8");
console.log("
Saved to: " + outPath);
