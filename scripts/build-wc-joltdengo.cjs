#!/usr/bin/env node
const path = require("path");
const fs = require("fs");
const cards = require(path.join(__dirname, "..", "dist", "cards-western.json"));

function findCard(name, setName, number) {
  const match = cards.find(c => {
    const cardName = c.names?.en || c.name || "";
    return cardName === name && c.set === setName && c.number === String(number);
  });
  if (!match) {
    console.error("WARNING: Could not find card: " + name + " | " + setName + " | " + number);
    return null;
  }
  return match;
}

function ptcgoLine(qty, card) {
  const name = card.names?.en || card.name || "???";
  return "* " + qty + " " + name + " " + card.set + " " + card.number;
}

const pokemon = [
  { qty: 3, name: "Gholdengo ex", set: "Paradox Rift", num: "139" },
  { qty: 4, name: "Gimmighoul", set: "Surging Sparks", num: "097" },
  { qty: 2, name: "Iron Hands ex", set: "Paradox Rift", num: "070" },
  { qty: 2, name: "Genesect ex", set: "Black Bolt", num: "067" },
  { qty: 2, name: "Joltik", set: "Stellar Crown", num: "050" },
  { qty: 1, name: "Miraidon ex", set: "Scarlet & Violet", num: "081" },
  { qty: 1, name: "Pikachu ex", set: "Surging Sparks", num: "057" },
  { qty: 1, name: "Fezandipiti ex", set: "Shrouded Fable", num: "038" },
  { qty: 1, name: "Latias ex", set: "Surging Sparks", num: "076" },
];

const trainers = [
  { qty: 4, name: "Arven", set: "Scarlet & Violet", num: "166" },
  { qty: 3, name: "Boss" + String.fromCharCode(39) + "s Orders", set: "Paldea Evolved", num: "172" },
  { qty: 2, name: "Brock" + String.fromCharCode(39) + "s Scouting", set: "Journey Together", num: "146" },
  { qty: 1, name: "Professor Turo" + String.fromCharCode(39) + "s Scenario", set: "Paradox Rift", num: "171" },
  { qty: 1, name: "Team Rocket" + String.fromCharCode(39) + "s Petrel", set: "Destined Rivals", num: "176" },
  { qty: 2, name: "Levincia", set: "Journey Together", num: "150" },
  { qty: 4, name: "Nest Ball", set: "Scarlet & Violet", num: "181" },
  { qty: 4, name: "Superior Energy Retrieval", set: "Paldea Evolved", num: "189" },
  { qty: 3, name: "Buddy-Buddy Poffin", set: "Temporal Forces", num: "144" },
  { qty: 2, name: "Earthen Vessel", set: "Paradox Rift", num: "163" },
  { qty: 2, name: "Pok" + "\u00e9" + "gear 3.0", set: "Black Bolt", num: "084" },
  { qty: 1, name: "Prime Catcher", set: "Temporal Forces", num: "157" },
  { qty: 2, name: "Air Balloon", set: "Black Bolt", num: "079" },
  { qty: 1, name: "Bravery Charm", set: "Paldea Evolved", num: "173" },
];

const energy = [
  { qty: 4, name: "Basic Grass Energy", set: "Scarlet & Violet Energies", num: "1" },
  { qty: 4, name: "Basic Lightning Energy", set: "Scarlet & Violet Energies", num: "4" },
  { qty: 3, name: "Basic Metal Energy", set: "Scarlet & Violet Energies", num: "8" },
];

const deckLines = [];
let totalCards = 0;
let pokemonCount = pokemon.reduce((s, e) => s + e.qty, 0);
let trainerCount = trainers.reduce((s, e) => s + e.qty, 0);
let energyCount = energy.reduce((s, e) => s + e.qty, 0);

deckLines.push("****** Pokémon Trading Card Game Deck List ******");
deckLines.push("");
deckLines.push("##Pokémon - " + pokemonCount);
deckLines.push("");
for (const entry of pokemon) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) { deckLines.push(ptcgoLine(entry.qty, card)); totalCards += entry.qty; }
}
deckLines.push("");
deckLines.push("##Trainer Cards - " + trainerCount);
deckLines.push("");
for (const entry of trainers) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) { deckLines.push(ptcgoLine(entry.qty, card)); totalCards += entry.qty; }
}
deckLines.push("");
deckLines.push("##Energy - " + energyCount);
deckLines.push("");
for (const entry of energy) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) { deckLines.push(ptcgoLine(entry.qty, card)); totalCards += entry.qty; }
}
deckLines.push("");
deckLines.push("Total Cards - " + totalCards);
deckLines.push("");
deckLines.push("****** Deck List Generated by SimpleDex ******");
deckLines.push("");

const output = deckLines.join(String.fromCharCode(10));
console.log(output);
console.log("" + String.fromCharCode(10) + "--- Validation ---");
console.log("Pokemon: " + pokemonCount);
console.log("Trainers: " + trainerCount);
console.log("Energy: " + energyCount);
console.log("Total: " + totalCards + " (expected 60)");
if (totalCards !== 60) { console.error("ERROR: Deck does not have 60 cards!"); process.exit(1); }
const allEntries = [...pokemon, ...trainers];
for (const entry of allEntries) {
  if (entry.qty > 4) { console.error("ERROR: " + entry.name + " has " + entry.qty + " copies!"); process.exit(1); }
}
console.log("All card counts valid.");
const outPath = path.join(__dirname, "..", "decklists", "WC-2025-Joltdengo.txt");
fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, output, "utf8");
console.log("" + String.fromCharCode(10) + "Saved to: " + outPath);