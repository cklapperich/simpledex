#!/usr/bin/env node
const path = require("path");
const fs = require("fs");
const cards = require(path.join(__dirname, "..", "dist", "cards-western.json"));

function findCard(name, setName, number) {
  const match = cards.find(c => {
    const cardName = c.names?.en || c.name || "";
    return cardName === name && c.set === setName && c.number === String(number);
  });
  if (!match) {
    console.error("WARNING: Could not find card: " + name + " | " + setName + " | " + number);
    return null;
  }
  return match;
}

function ptcgoLine(qty, card) {
  const name = card.names?.en || card.name || "???";
  return "* " + qty + " " + name + " " + card.set + " " + card.number;
}

const pokemon = [
  { qty: 3, name: "Dragapult ex",     set: "Twilight Masquerade",   num: "130" },
  { qty: 4, name: "Drakloak",         set: "Twilight Masquerade",   num: "129" },
  { qty: 4, name: "Dreepy",           set: "Twilight Masquerade",   num: "128" },
  { qty: 1, name: "Dusknoir",         set: "Shrouded Fable",        num: "020" },
  { qty: 2, name: "Dusclops",         set: "Shrouded Fable",        num: "019" },
  { qty: 2, name: "Duskull",          set: "Shrouded Fable",        num: "018" },
  { qty: 2, name: "Budew",            set: "Prismatic Evolutions",  num: "004" },
  { qty: 1, name: "Fezandipiti ex",   set: "Shrouded Fable",        num: "038" },
  { qty: 1, name: "Genesect",         set: "Shrouded Fable",        num: "040" },
  { qty: 1, name: "Hawlucha",         set: "Scarlet & Violet",      num: "118" },
  { qty: 1, name: "Munkidori",        set: "Twilight Masquerade",   num: "095" },
];

const trainers = [
  { qty: 4, name: "Iono",               set: "Paldea Evolved",      num: "185" },
  { qty: 3, name: "Professor's Research", set: "Scarlet & Violet",   num: "189" },
  { qty: 2, name: "Arven",              set: "Scarlet & Violet",    num: "166" },
  { qty: 2, name: "Boss's Orders",      set: "Paldea Evolved",      num: "172" },
  { qty: 1, name: "Brock's Scouting",   set: "Journey Together",    num: "146" },
  { qty: 1, name: "Hilda",              set: "White Flare",         num: "084" },
  { qty: 1, name: "Jamming Tower",      set: "Twilight Masquerade", num: "153" },
  { qty: 4, name: "Buddy-Buddy Poffin", set: "Temporal Forces",     num: "144" },
  { qty: 4, name: "Ultra Ball",         set: "Scarlet & Violet",    num: "196" },
  { qty: 3, name: "Counter Catcher",    set: "Paradox Rift",        num: "160" },
  { qty: 3, name: "Night Stretcher",    set: "Shrouded Fable",      num: "061" },
  { qty: 1, name: "Rare Candy",         set: "Scarlet & Violet",    num: "191" },
  { qty: 2, name: "Air Balloon",        set: "Black Bolt",          num: "079" },
];

const energy = [
  { qty: 2, name: "Basic Psychic Energy",  set: "Scarlet & Violet Energies", num: "5" },
  { qty: 1, name: "Basic Fire Energy",     set: "Scarlet & Violet Energies", num: "2" },
  { qty: 3, name: "Luminous Energy",       set: "Paldea Evolved",            num: "191" },
  { qty: 1, name: "Neo Upper Energy",      set: "Temporal Forces",           num: "162" },
];

const deckLines = [];
let totalCards = 0;
let pokemonCount = pokemon.reduce((s, e) => s + e.qty, 0);
let trainerCount = trainers.reduce((s, e) => s + e.qty, 0);
let energyCount = energy.reduce((s, e) => s + e.qty, 0);

deckLines.push("****** Pok\u00e9mon Trading Card Game Deck List ******");
deckLines.push("");
deckLines.push("##Pok\u00e9mon - " + pokemonCount);
deckLines.push("");

for (const entry of pokemon) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) { deckLines.push(ptcgoLine(entry.qty, card)); totalCards += entry.qty; }
}

deckLines.push("");
deckLines.push("##Trainer Cards - " + trainerCount);
deckLines.push("");

for (const entry of trainers) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) { deckLines.push(ptcgoLine(entry.qty, card)); totalCards += entry.qty; }
}

deckLines.push("");
deckLines.push("##Energy - " + energyCount);
deckLines.push("");

for (const entry of energy) {
  const card = findCard(entry.name, entry.set, entry.num);
  if (card) { deckLines.push(ptcgoLine(entry.qty, card)); totalCards += entry.qty; }
}

deckLines.push("");
deckLines.push("Total Cards - " + totalCards);
deckLines.push("");
deckLines.push("****** Deck List Generated by SimpleDex ******");
deckLines.push("");

const output = deckLines.join("\n");
console.log(output);

if (totalCards !== 60) {
  console.error("\nERROR: Deck has " + totalCards + " cards, expected 60!");
} else {
  console.log("\nDeck validation: 60 cards - OK");
}

const allEntries = [...pokemon, ...trainers, ...energy];
for (const entry of allEntries) {
  if (entry.qty > 4 && !entry.name.startsWith("Basic ")) {
    console.error("ERROR: " + entry.name + " has " + entry.qty + " copies (max 4)!");
  }
}

const outPath = path.join(__dirname, "..", "decklists", "WC-2025-Pult-Bomb.txt");
fs.mkdirSync(path.dirname(outPath), { recursive: true });
fs.writeFileSync(outPath, output, "utf8");
console.log("Saved to: " + outPath);
